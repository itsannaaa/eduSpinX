<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>eduSpinX</title>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Poppins', sans-serif; background: #f4f7f6; display: flex; flex-direction: column; align-items: center; min-height: 100vh; margin: 0; padding: 20px; }
        
        /* WRAPPER RODA - DIPAKSA CENTER */
        #wheel-wrapper { 
            position: relative; 
            width: 400px; 
            height: 400px; 
            margin: 20px auto; 
            display: flex;
            justify-content: center;
        }
        
        /* JARUM HITAM - PASTI CENTER */
        #pointer {
            position: absolute; top: -15px; left: 50%; transform: translateX(-50%);
            width: 0; height: 0; 
            border-left: 18px solid transparent; border-right: 18px solid transparent;
            border-top: 40px solid #000000; 
            z-index: 100; filter: drop-shadow(0 3px 2px rgba(0,0,0,0.3));
        }

        canvas { display: block; width: 100%; height: 100%; border-radius: 50%; border: 12px solid #333; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        
        #spinBtn { 
            padding: 15px 50px; font-size: 22px; font-weight: bold; cursor: pointer; 
            background: #27ae60; color: white; border: none; border-radius: 50px; 
            transition: 0.3s; width: 100%; max-width: 400px; margin: 20px 0;
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.4);
        }
        #spinBtn:hover { background: #219150; transform: scale(1.05); }
        #spinBtn:disabled { background: #bdc3c7; cursor: not-allowed; }

        .controls { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); width: 100%; max-width: 400px; text-align: center; }
        textarea { width: 92%; height: 60px; padding: 10px; border-radius: 8px; border: 1px solid #ddd; font-family: inherit; resize: none; margin-bottom: 5px;}
        .status { font-size: 11px; color: #7f8c8d; margin-bottom: 5px; }
    </style>
</head>
<body>

    <audio id="spinSound" src="spin.mp3" preload="auto"></audio>
    <audio id="winSound" src="win.mp3" preload="auto"></audio>

    <h1>üé° eduSpinX</h1>
   <div style="font-weight: bold; color: #2c3e50; margin-bottom: 10px;">
   üöÄ Revolusi Pembelajaran Digital
</div>

    <div id="wheel-wrapper">
        <div id="pointer"></div>
        <canvas id="wheel" width="500" height="500"></canvas>
    </div>

    <button id="spinBtn" onclick="spinWheel()">PUTAR RODA</button>

   <div class="controls">
        <p style="font-size: 13px; font-weight: bold; margin-bottom: 8px;">TOPIK</p>
        <textarea id="listTajuk" placeholder="Contoh: Melaka, Jepun, British">Melaka, Jepun, British, Tokoh</textarea>
        
        <button onclick="updateManual()" style="background: #3498db; margin-top: 5px; font-size: 16px;">
            üöÄ HANTAR KE RODA
        </button>
        
        <p class="status" id="cloudStatus">‚òÅÔ∏è Cloud Active</p>
    </div>

    <script>
        // ======= KONFIGURASI =======
        const CLOUD_URL = "https://script.google.com/macros/s/AKfycbyg91Ef_VQuCyp4oOpuwBMj6pp-ebbLXBnq9i8t-BA-puM9WSVV2NH44xRCw0ssW7XuzQ/exec"; 
        const LINK_GFORM = "https://forms.gle/Yyo7JJTLmqhSxE9QA";
        // ===========================

        const canvas = document.getElementById("wheel");
        const ctx = canvas.getContext("2d");
        const spinAudio = document.getElementById("spinSound");
        const winAudio = document.getElementById("winSound");
        const txtArea = document.getElementById("listTajuk");
        const statusTxt = document.getElementById("cloudStatus");
        const btnSpin = document.getElementById("spinBtn");

        let tajuk = [];
        let colors = ["#1abc9c", "#3498db", "#9b59b6", "#f1c40f", "#e67e22", "#e74c3c", "#2ecc71", "#d35400"];
        let currentRotation = 0;
        let isSpinning = false;

        // 1. FUNGSI UNTUK HANTAR DATA KE RODA
        function updateManual() {
            const input = txtArea.value;
            // Pecahkan teks mengikut koma dan buang ruang kosong
            tajuk = input.split(",").map(s => s.trim()).filter(s => s !== "");
            
            if (tajuk.length > 0) {
                // Terus lukis roda tanpa keluar pop-up 'Success'
                drawWheel();
            } else {
                // Amaran ini dikekalkan supaya cikgu tahu jika kotak kosong
                Swal.fire('Ops!', 'Sila masukkan sekurang-kurangnya satu tajuk.', 'error');
            }
        }

       // FUNGSI SYNC CLOUD (VERSI AUTO-UPDATE RODA)
        async function syncCloud() {
            try {
                const res = await fetch(CLOUD_URL);
                const data = await res.json();
                
                // Jika ada data baru yang berbeza
                if(data && JSON.stringify(data) !== JSON.stringify(tajuk)) {
                    
                    tajuk = data; 
                    txtArea.value = tajuk.join(", ");
                    
                    // Roda berubah di sini tanpa keluar apa-apa teks status
                    drawWheel(); 
                }
            } catch (e) {
                // Biarkan kosong supaya tiada gangguan pada paparan
            }
        }
        function drawWheel() {
            const size = tajuk.length;
            const arc = (2 * Math.PI) / size;
            ctx.clearRect(0, 0, 500, 500);

            tajuk.forEach((text, i) => {
                const angle = i * arc;
                ctx.fillStyle = colors[i % colors.length];
                ctx.beginPath();
                ctx.moveTo(250, 250);
                ctx.arc(250, 250, 240, angle, angle + arc);
                ctx.fill();
                ctx.strokeStyle = "white";
                ctx.lineWidth = 2;
                ctx.stroke();

                ctx.save();
                ctx.translate(250, 250);
                ctx.rotate(angle + arc / 2);
                ctx.fillStyle = "white";
                ctx.font = "bold 18px Poppins";
                ctx.textAlign = "right";
                ctx.fillText(text, 220, 10);
                ctx.restore();
            });
        }

        // Fungsi spinWheel dan showResult dikekalkan sama...
        function spinWheel() {
            if (isSpinning || tajuk.length === 0) return;
            isSpinning = true;
            btnSpin.disabled = true;
            spinAudio.currentTime = 0;
            spinAudio.loop = true;
            spinAudio.play();
            const extraSpins = 5 + Math.random() * 5;
            const rotationDegree = extraSpins * 360 + Math.random() * 360;
            currentRotation += rotationDegree;
            canvas.style.transition = "transform 4s cubic-bezier(0.15, 0, 0.15, 1)";
            canvas.style.transform = `rotate(${currentRotation}deg)`;
            setTimeout(() => {
                isSpinning = false;
                btnSpin.disabled = false;
                spinAudio.pause();
                winAudio.play();
                showResult();
            }, 4000);
        }

        function showResult() {
    const size = tajuk.length;
    const arc = 360 / size;
    const index = Math.floor(((360 - (currentRotation % 360) + 270) % 360) / arc);
    const pemenang = tajuk[index]; // Simpan nama pemenang

    Swal.fire({
        title: 'TAHNIAH!',
        html: `Kumpulan anda mendapat:<br><b style="font-size:26px; color:#27ae60;">${pemenang}</b><br><br><div id="qrcode" style="display:flex; justify-content:center;"></div>`,
        confirmButtonText: 'OK', // Tukar teks butang
        didOpen: () => { 
            new QRCode(document.getElementById("qrcode"), { text: LINK_GFORM, width: 160, height: 160 }); 
        }
    }).then((result) => {
        if (result.isConfirmed) {
            // PROSES PADAM NAMA:
            // Buang nama pemenang tadi daripada array 'tajuk'
            tajuk.splice(index, 1);
            
            // Kemaskini kotak textarea supaya selari
            txtArea.value = tajuk.join(", ");
            
            // Lukis semula roda tanpa nama tersebut
            drawWheel();
        }
    });
}

        window.onload = () => {
            updateManual(); // Lukis roda pertama kali
            syncCloud();    // Ambil data cloud
            setInterval(syncCloud, 5000); // Check cloud setiap 5 saat
        };
    </script>
</body>
</html>