<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>eduSpinX</title>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; background: #f4f7f6; display: flex; flex-direction: column; align-items: center; min-height: 100vh; margin: 0; padding: 20px; }
        #wheel-wrapper { position: relative; width: 400px; height: 400px; margin: 20px auto; display: flex; justify-content: center; }
        #pointer { position: absolute; top: -15px; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 18px solid transparent; border-right: 18px solid transparent; border-top: 40px solid #000000; z-index: 100; pointer-events: none; }
        canvas { display: block; width: 100%; height: 100%; border-radius: 50%; border: 12px solid #333; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        #spinBtn { padding: 15px 50px; font-size: 22px; font-weight: bold; cursor: pointer; background: #27ae60; color: white; border: none; border-radius: 50px; transition: 0.3s; width: 100%; max-width: 400px; margin: 20px 0; box-shadow: 0 5px 15px rgba(39, 174, 96, 0.4); }
        #spinBtn:hover { background: #219150; transform: scale(1.05); }
        #spinBtn:disabled { background: #bdc3c7; }
        .controls { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); width: 100%; max-width: 400px; text-align: center; position: relative; z-index: 10; }
        textarea { width: 92%; height: 60px; padding: 10px; border-radius: 8px; border: 1px solid #ddd; font-family: inherit; resize: none; margin-bottom: 5px; text-align: center; }

        @keyframes vibrate {
            0% { transform: translate(0); }
            20% { transform: translate(-2px, 2px); }
            40% { transform: translate(-2px, -2px); }
            60% { transform: translate(2px, 2px); }
            80% { transform: translate(2px, -2px); }
            100% { transform: translate(0); }
        }

        .rocket-active {
            display: inline-block !important;
            animation: vibrate 0.3s linear infinite !important;
            font-size: 40px !important;
        }
    </style>
</head>
<body>

<audio id="spinSound" preload="auto"><source src="spin.mp3" type="audio/mpeg"></audio>
<audio id="winSound" preload="auto"><source src="win.mp3" type="audio/mpeg"></audio>

<div style="width: 100%; text-align: center; margin-top: 10px; margin-bottom: 20px;">
    <h1 style="margin: 0; font-size: 35px; color: #2c3e50; letter-spacing: 1px;">
        ðŸŽ¡ <span style="color: #27ae60;">edu</span>SpinX
    </h1>
    <p style="margin: 5px 0 0 0; font-size: 16px; color: #819091; font-weight: bold; text-transform: uppercase; letter-spacing: 2px;">
        ðŸš€ Revolusi Pembelajaran Digital
    </p>
</div>

<div id="wheel-wrapper">
    <div id="pointer"></div>
    <canvas id="wheel" width="500" height="500"></canvas>
</div>

<button id="spinBtn" onclick="spinWheel()">PUTAR RODA</button>

<div class="controls">
    <p style="font-size: 13px; font-weight: bold; margin-bottom: 8px;">TOPIK</p>
    <textarea id="listTajuk" placeholder="Tarik data dari Cloud..."></textarea>

    <div style="display: flex; justify-content: center; gap: 40px; margin-top: 15px;">
        <button onclick="resetRoda()" title="Reset Roda" style="background: none; border: none; cursor: pointer; font-size: 26px; transition: 0.2s;">
            ðŸ”„
        </button>
        <button id="roketBtn" onclick="updateManual()" style="background: none; border: none; cursor: pointer; font-size: 30px; transition: 0.3s;">
            ðŸš€
        </button>
    </div>
</div>

<script>
    const CLOUD_URL = "https://script.google.com/macros/s/AKfycbyg91Ef_VQuCyp4oOpuwBMj6pp-ebbLXBnq9i8t-BA-puM9WSVV2NH44xRCw0ssW7XuzQ/exec"; 
    const LINK_GFORM = "https://linktr.ee/CikguAnna_Najwa_Zatie";

    const canvas = document.getElementById("wheel");
    const ctx = canvas.getContext("2d");
    const txtArea = document.getElementById("listTajuk");
    const btnSpin = document.getElementById("spinBtn");

    let tajuk = [];
    let colors = ["#1abc9c", "#3498db", "#9b59b6", "#f1c40f", "#e67e22", "#e74c3c", "#2ecc71", "#d35400"];
    let currentRotation = 0;
    let isSpinning = false;

    async function tarikDataCloud() {
        const btnRoket = document.getElementById("roketBtn");

        try {
            // Hanya aktifkan animasi getar (Audio Whoosh telah dibuang)
            if (btnRoket) btnRoket.classList.add("rocket-active");

            const res = await fetch(CLOUD_URL);
            const data = await res.json();
            
            if(data && data.length > 0) {
                tajuk = data;
                txtArea.value = tajuk.join(", ");
                drawWheel();
            }
        } catch (e) { 
            console.log("Gagal tarik data");
            Swal.fire("Ops!", "Gagal hubungi Cloud. Periksa internet.", "error");
        } finally {
            setTimeout(() => {
                if (btnRoket) btnRoket.classList.remove("rocket-active");
            }, 800);
        }
    }

    function updateManual() {
        if (txtArea.value.trim() === "") {
            tarikDataCloud();
        } else {
            tajuk = txtArea.value.split(",").map(s => s.trim()).filter(s => s !== "");
            drawWheel();
        }
    }

    function resetRoda() {
        tajuk = [];
        txtArea.value = "";
        drawWheel();
    }

    function drawWheel() {
        const size = tajuk.length;
        if (size === 0) {
            ctx.clearRect(0, 0, 500, 500);
            return;
        }
        const arc = (2 * Math.PI) / size;
        ctx.clearRect(0, 0, 500, 500);
        tajuk.forEach((text, i) => {
            const angle = i * arc;
            ctx.fillStyle = colors[i % colors.length];
            ctx.beginPath(); ctx.moveTo(250, 250);
            ctx.arc(250, 250, 240, angle, angle + arc);
            ctx.fill(); ctx.strokeStyle = "white"; ctx.lineWidth = 2; ctx.stroke();
            ctx.save(); ctx.translate(250, 250); ctx.rotate(angle + arc / 2);
            ctx.fillStyle = "white"; ctx.font = "bold 18px Poppins"; ctx.textAlign = "right";
            ctx.fillText(text, 220, 10); ctx.restore();
        });
    }

    function spinWheel() {
        if (isSpinning || tajuk.length === 0) return;
        isSpinning = true; btnSpin.disabled = true;
        
        const spinAudio = document.getElementById("spinSound");
        if (spinAudio) {
            spinAudio.currentTime = 0;
            spinAudio.play();
        }

        const rotationDegree = (5 + Math.random() * 5) * 360 + Math.random() * 360;
        currentRotation += rotationDegree;
        canvas.style.transition = "transform 4s cubic-bezier(0.15, 0, 0.15, 1)";
        canvas.style.transform = `rotate(${currentRotation}deg)`;

        setTimeout(() => {
            isSpinning = false; btnSpin.disabled = false;
            if (spinAudio) spinAudio.pause();
            const winAudio = document.getElementById("winSound");
            if (winAudio) winAudio.play();
            showResult();
        }, 4000);
    }

    function showResult() {
        const size = tajuk.length;
        const arc = 360 / size;
        const index = Math.floor(((360 - (currentRotation % 360) + 270) % 360) / arc);
        const pemenang = tajuk[index];

        Swal.fire({
            title: 'TAHNIAH!',
            html: `Kumpulan anda mendapat:<br><b style="font-size:26px; color:#27ae60;">${pemenang}</b><br><br><div id="qrcode" style="display:flex; justify-content:center;"></div>`,
            confirmButtonText: 'OK',
            didOpen: () => { new QRCode(document.getElementById("qrcode"), { text: LINK_GFORM, width: 160, height: 160 }); }
        }).then((result) => {
            if (result.isConfirmed) {
                tajuk.splice(index, 1);
                txtArea.value = tajuk.join(", ");
                drawWheel();
            }
        });
    }

    window.onload = () => { 
        document.getElementById("spinSound").load();
        document.getElementById("winSound").load();
        drawWheel(); 
    };
</script>
</body>
</html>
